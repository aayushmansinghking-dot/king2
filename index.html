<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JP RESIDENCY</title>
<style>
/* ================= CSS ================= */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{min-height:100vh;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:white;overflow-x:hidden;}
.watermark{position:fixed;top:50%;left:50%;font-size:400px;transform:translate(-50%,-50%);color:rgba(255,255,255,0.03);font-weight:900;pointer-events:none;z-index:0;}
header{text-align:center;padding:40px;animation:fadeDown 1.5s ease;z-index:1;position:relative;}
header h1{font-size:48px;letter-spacing:3px;}
header p{font-size:18px;opacity:0.8;}
@keyframes fadeDown{from{opacity:0;transform:translateY(-40px);}to{opacity:1;transform:translateY(0);}}
button{padding:12px 25px;border:none;border-radius:8px;background:linear-gradient(45deg,#ff512f,#dd2476);color:white;cursor:pointer;font-size:16px;margin:5px;transition:0.3s;}
button:hover{opacity:0.9;transform:scale(1.05);}
.form-container{max-width:700px;margin:20px auto;background:rgba(0,0,0,0.6);padding:30px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5);}
form h2{margin-bottom:10px;color:#ffdd57;}
form input, form select, form textarea{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;font-size:16px;}
.form-buttons{display:flex;justify-content:space-between;flex-wrap:wrap;}
footer{text-align:center;margin-top:40px;font-size:14px;opacity:0.6;}
</style>
</head>
<body>

<div class="watermark">A</div>
<header>
  <h1>JP RESIDENCY</h1>
  <p>Managed by Aayushman Singh | Live as a Family</p>
</header>

<!-- ================= HOMEPAGE ================= -->
<div id="homepage" class="form-container">
  <h2>Welcome to JP Residency</h2>
  <button onclick="showPage('registration')">NEW REGISTRATION</button>
  <button onclick="showPage('login')">ALREADY REGISTERED</button>
  <button onclick="showPage('ownerLogin')">OWNER LOGIN</button>
</div>

<!-- ================= REGISTRATION FORM ================= -->
<div id="registration" class="form-container" style="display:none;">
  <h2>New Registration</h2>
  <form id="registrationForm">
    <h3>Personal Details</h3>
    <input type="text" id="fullname" placeholder="Full Name" required>
    <select id="gender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <input type="tel" id="phone" placeholder="Phone Number" required>
    <input type="email" id="email" placeholder="Email ID" required>
    <textarea id="address" placeholder="Full Address" required></textarea>
    <select id="idType" required>
      <option value="">Select ID Type</option>
      <option value="Aadhar Card">Aadhar Card</option>
      <option value="Passport">Passport</option>
      <option value="Voter ID">Voter ID</option>
    </select>
    <input type="text" id="idNumber" placeholder="ID Number" required>

    <h3>Room Details</h3>
    <input type="date" id="livingDate" required>
    <input type="number" id="numberGuests" placeholder="Number of Guests" min="1" required>

    <h3>Payment Details</h3>
    <input type="number" id="roomRent" placeholder="Room Rent per Month (â‚¹)" min="0" required>
    <input type="number" id="advancePaid" placeholder="Advance Paid (â‚¹)" min="0" required>
    <input type="number" id="prevElectric" placeholder="Previous Electric Meter Reading" min="0" required>

    <h3>Upload Documents</h3>
    <input type="file" id="aadharImage" accept="image/*" required>
    <input type="file" id="signatureImage" accept="image/*" required>
    <input type="file" id="prevElectricImage" accept="image/*" required>

    <h3>Create Password</h3>
    <input type="password" id="password" placeholder="Password" required>

    <div class="form-buttons">
      <button type="submit">Submit Registration</button>
      <button type="button" onclick="showPage('homepage')">Cancel</button>
    </div>
  </form>
</div>

<!-- ================= END OF SLOT 1 ================= -->
 <!-- ================= LOGIN FORM ================= -->
<div id="login" class="form-container" style="display:none;">
  <h2>Already Registered Login</h2>
  <input type="text" id="loginReg" placeholder="Registration Number (JPXXXX)" required>
  <input type="password" id="loginPass" placeholder="Password" required>
  <div class="form-buttons">
    <button onclick="loginUser()">Login</button>
    <button onclick="showPage('homepage')">Back</button>
  </div>
</div>

<!-- ================= OWNER LOGIN ================= -->
<div id="ownerLogin" class="form-container" style="display:none;">
  <h2>Owner Login</h2>
  <input type="password" id="ownerPassword" placeholder="Owner Password" required>
  <div class="form-buttons">
    <button onclick="ownerLogin()">Login</button>
    <button onclick="showPage('homepage')">Back</button>
  </div>
</div>

<!-- ================= JS ================= -->
<script type="module">
  // ================= Show/Hide Sections =================
  function showPage(id){
    document.getElementById('homepage').style.display='none';
    document.getElementById('registration').style.display='none';
    document.getElementById('login').style.display='none';
    document.getElementById('ownerLogin').style.display='none';
    if(document.getElementById(id)) document.getElementById(id).style.display='block';
  }

  // ================= Firebase =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref as dbRef, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-e_jlc5bQHfoGZj75oHh-3Pf6YfP4dl4",
    authDomain: "jp-residency-7c40a.firebaseapp.com",
    databaseURL: "https://jp-residency-7c40a-default-rtdb.firebaseio.com",
    projectId: "jp-residency-7c40a",
    storageBucket: "jp-residency-7c40a.appspot.com",
    messagingSenderId: "509355957860",
    appId: "1:509355957860:web:16d21bc146d67a4362c971"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // ================= REGISTRATION =================
  const form = document.getElementById("registrationForm");
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const fullname = document.getElementById("fullname").value.trim();
    const gender = document.getElementById("gender").value;
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();
    const address = document.getElementById("address").value.trim();
    const idType = document.getElementById("idType").value;
    const idNumber = document.getElementById("idNumber").value.trim();
    const livingDate = document.getElementById("livingDate").value;
    const numberGuests = document.getElementById("numberGuests").value;
    const roomRent = document.getElementById("roomRent").value;
    const advancePaid = document.getElementById("advancePaid").value;
    const prevElectric = document.getElementById("prevElectric").value;
    const password = document.getElementById("password").value;

    const aadharFile = document.getElementById("aadharImage").files[0];
    const signatureFile = document.getElementById("signatureImage").files[0];
    const electricFile = document.getElementById("prevElectricImage").files[0];

    if(!fullname||!gender||!phone||!email||!address||!idType||!idNumber||
       !livingDate||!numberGuests||!roomRent||!advancePaid||!prevElectric||!password||
       !aadharFile||!signatureFile||!electricFile){
      alert("Please fill all fields and upload all documents.");
      return;
    }

    // Generate unique registration number
    const regNumber = "JP"+Math.floor(1000+Math.random()*9000);

    try{
      // Upload documents to Firebase Storage
      const aadharRef = storageRef(storage, `users/${regNumber}/aadhar.jpg`);
      const signatureRef = storageRef(storage, `users/${regNumber}/signature.jpg`);
      const electricRef = storageRef(storage, `users/${regNumber}/electric.jpg`);
      await uploadBytes(aadharRef, aadharFile);
      await uploadBytes(signatureRef, signatureFile);
      await uploadBytes(electricRef, electricFile);

      const aadharURL = await getDownloadURL(aadharRef);
      const signatureURL = await getDownloadURL(signatureRef);
      const electricURL = await getDownloadURL(electricRef);

      // Save user data to Firebase Realtime Database
      await set(dbRef(db, `users/${regNumber}`), {
        regNumber, fullname, gender, phone, email, address, idType, idNumber,
        livingDate, numberGuests, roomRent, advancePaid, prevElectric, password,
        documents:{aadharURL, signatureURL, electricURL}
      });

      alert(`Registration successful! Your registration number is ${regNumber}`);
      form.reset();
      showPage('homepage');
    }catch(err){console.error(err); alert("Error during registration.");}
  });

  // ================= LOGIN =================
  window.loginUser = async function(){
    const reg = document.getElementById("loginReg").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if(!reg||!pass){ alert("Enter Registration Number and Password"); return; }
    const snap = await get(dbRef(db, `users/${reg}`));
    if(!snap.exists()){ alert("Invalid Registration Number"); return; }
    const data = snap.val();
    if(data.password!==pass){ alert("Incorrect Password"); return; }
    alert(`Welcome ${data.fullname}! Dashboard functionality coming in next slot.`);
  }

  // ================= OWNER LOGIN =================
  window.ownerLogin = function(){
    const pass = document.getElementById("ownerPassword").value;
    if(pass==="AMS"){
      alert("Owner login successful. Editable dashboard coming in next slot.");
    }else{
      alert("Incorrect Owner Password");
    }
  }

</script>

<!-- ================= END OF SLOT 2 ================= --> 
  <!-- ================= DASHBOARD FOR USER ================= -->
<div id="userDashboard" class="form-container" style="display:none;">
  <h2>User Dashboard</h2>
  <div id="userInfo">
    <!-- Personal info will be displayed here dynamically -->
  </div>

  <h3>Payment Details</h3>
  <table border="1" style="width:100%;text-align:center;color:black;background:white;border-radius:8px;overflow:hidden;">
    <thead>
      <tr>
        <th>Month</th>
        <th>Rent (â‚¹)</th>
        <th>Status</th>
        <th>Payment Date</th>
      </tr>
    </thead>
    <tbody id="paymentTable">
      <!-- Rows added dynamically -->
    </tbody>
  </table>

  <h3>Electric Bill Details</h3>
  <table border="1" style="width:100%;text-align:center;color:black;background:white;border-radius:8px;overflow:hidden;">
    <thead>
      <tr>
        <th>Previous Reading</th>
        <th>Current Reading</th>
        <th>Rate per Unit (â‚¹)</th>
        <th>Amount Paid (â‚¹)</th>
        <th>Payment Date</th>
      </tr>
    </thead>
    <tbody id="electricTable">
      <!-- Rows added dynamically -->
    </tbody>
  </table>

  <h3>Electric Bill Calculator</h3>
  <input type="number" id="calcPrev" placeholder="Previous Reading">
  <input type="number" id="calcCurrent" placeholder="Current Reading">
  <input type="number" id="calcRate" placeholder="Rate per Unit">
  <button onclick="calculateBill()">Calculate Bill</button>
  <p id="calcResult" style="margin-top:10px;font-weight:bold;"></p>

  <button onclick="showPage('homepage')">Go to Homepage</button>
</div>

<script type="module">
  // ================= USER DASHBOARD LOGIC =================
  async function showUserDashboard(reg, data){
    showPage('userDashboard');
    document.getElementById('userInfo').innerHTML=`
      <p><strong>Name:</strong> ${data.fullname}</p>
      <p><strong>Gender:</strong> ${data.gender}</p>
      <p><strong>Phone:</strong> ${data.phone}</p>
      <p><strong>Email:</strong> ${data.email}</p>
      <p><strong>Address:</strong> ${data.address}</p>
      <p><strong>ID:</strong> ${data.idType} - ${data.idNumber}</p>
      <p><strong>Room Rent:</strong> â‚¹${data.roomRent}</p>
      <p><strong>Living Date:</strong> ${data.livingDate}</p>
      <p><strong>Number of Guests:</strong> ${data.numberGuests}</p>
    `;

    // ================= PAYMENT TABLE =================
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const paymentBody = document.getElementById('paymentTable');
    paymentBody.innerHTML="";
    const currentYear = new Date().getFullYear();

    months.forEach(month=>{
      const row = document.createElement('tr');
      row.innerHTML=`<td>${month} ${currentYear}</td>
                     <td>${data.roomRent}</td>
                     <td>Not Paid</td>
                     <td>-</td>`;
      paymentBody.appendChild(row);
    });

    // ================= ELECTRIC BILL TABLE =================
    const electricBody = document.getElementById('electricTable');
    electricBody.innerHTML="";
    const row = document.createElement('tr');
    row.innerHTML=`<td>${data.prevElectric}</td><td>-</td><td>-</td><td>-</td><td>-</td>`;
    electricBody.appendChild(row);
  }

  // ================= CALCULATE ELECTRIC BILL =================
  window.calculateBill = function(){
    const prev = Number(document.getElementById('calcPrev').value);
    const curr = Number(document.getElementById('calcCurrent').value);
    const rate = Number(document.getElementById('calcRate').value);
    if(isNaN(prev)||isNaN(curr)||isNaN(rate)||curr<prev){
      alert("Enter valid readings and rate");
      return;
    }
    const amount = (curr-prev)*rate;
    document.getElementById('calcResult').innerText=`Electric Bill Amount: â‚¹${amount}`;
  }

  // ================= EXTENDING LOGIN FUNCTION =================
  window.loginUser = async function(){
    const reg = document.getElementById("loginReg").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if(!reg||!pass){ alert("Enter Registration Number and Password"); return; }
    const snap = await get(dbRef(db, `users/${reg}`));
    if(!snap.exists()){ alert("Invalid Registration Number"); return; }
    const data = snap.val();
    if(data.password!==pass){ alert("Incorrect Password"); return; }
    // Show user dashboard
    showUserDashboard(reg, data);
  }
</script>

<!-- ================= END OF SLOT 3 ================= -->
  <!-- ================= OWNER DASHBOARD ================= -->
<div id="ownerDashboard" class="form-container" style="display:none;">
  <h2>Owner Panel</h2>
  <h3>Registered Users</h3>
  <div id="usersList" style="display:flex;flex-wrap:wrap;gap:10px;">
    <!-- Users buttons dynamically added here -->
  </div>

  <div id="ownerUserDetails" style="margin-top:20px;">
    <!-- Editable user details and tables will appear here -->
  </div>

  <div class="form-buttons">
    <button onclick="showPage('homepage')">Go to Homepage</button>
    <button onclick="loadUsers()">Reload User List</button>
  </div>
</div>

<script type="module">
  // ================= OWNER LOGIN EXTENSION =================
  window.ownerLogin = async function(){
    const pass = document.getElementById("ownerPassword").value;
    if(pass==="AMS"){
      showPage('ownerDashboard');
      loadUsers();
      alert("Owner login successful.");
    } else {
      alert("Incorrect Owner Password");
    }
  }

  // ================= LOAD ALL USERS =================
  async function loadUsers(){
    const usersSnap = await get(dbRef(db, 'users'));
    const usersList = document.getElementById('usersList');
    usersList.innerHTML="";
    if(usersSnap.exists()){
      const users = usersSnap.val();
      for(let reg in users){
        const btn = document.createElement('button');
        btn.textContent=`${reg} - ${users[reg].fullname}`;
        btn.onclick=()=>showOwnerUser(users[reg]);
        usersList.appendChild(btn);
      }
    } else {
      usersList.innerHTML="<p>No users registered yet.</p>";
    }
  }

  // ================= SHOW OWNER USER =================
  async function showOwnerUser(data){
    const container = document.getElementById('ownerUserDetails');
    container.innerHTML="";
    container.innerHTML=`
      <h3>Edit User: ${data.fullname} (${data.regNumber})</h3>
      <p><strong>Name:</strong> <input type="text" id="ownerName" value="${data.fullname}"></p>
      <p><strong>Gender:</strong> 
        <select id="ownerGender">
          <option value="Male" ${data.gender==="Male"?'selected':''}>Male</option>
          <option value="Female" ${data.gender==="Female"?'selected':''}>Female</option>
          <option value="Other" ${data.gender==="Other"?'selected':''}>Other</option>
        </select>
      </p>
      <p><strong>Phone:</strong> <input type="text" id="ownerPhone" value="${data.phone}"></p>
      <p><strong>Email:</strong> <input type="email" id="ownerEmail" value="${data.email}"></p>
      <p><strong>Address:</strong> <textarea id="ownerAddress">${data.address}</textarea></p>
      <p><strong>Room Rent:</strong> <input type="number" id="ownerRoomRent" value="${data.roomRent}"></p>

      <h4>Payment Table</h4>
      <table border="1" style="width:100%;text-align:center;color:black;background:white;border-radius:8px;overflow:hidden;">
        <thead>
          <tr><th>Month</th><th>Rent (â‚¹)</th><th>Status</th><th>Payment Date</th></tr>
        </thead>
        <tbody id="ownerPaymentTable">
        </tbody>
      </table>

      <h4>Electric Bill Table</h4>
      <table border="1" style="width:100%;text-align:center;color:black;background:white;border-radius:8px;overflow:hidden;">
        <thead>
          <tr><th>Previous Reading</th><th>Current Reading</th><th>Rate/unit</th><th>Amount Paid</th><th>Payment Date</th></tr>
        </thead>
        <tbody id="ownerElectricTable">
        </tbody>
      </table>

      <div class="form-buttons">
        <button onclick="saveOwnerChanges('${data.regNumber}')">Save Changes</button>
      </div>
    `;

    // Load payment table dynamically
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const paymentBody = document.getElementById('ownerPaymentTable');
    paymentBody.innerHTML="";
    months.forEach(month=>{
      const row = document.createElement('tr');
      row.innerHTML=`<td>${month}</td>
                     <td><input type="number" value="${data.roomRent}" style="width:80px;"></td>
                     <td>
                       <select>
                         <option value="Paid">Paid</option>
                         <option value="Not Paid" selected>Not Paid</option>
                       </select>
                     </td>
                     <td><input type="date"></td>`;
      paymentBody.appendChild(row);
    });

    // Electric table dynamically
    const eBody = document.getElementById('ownerElectricTable');
    eBody.innerHTML="";
    const eRow = document.createElement('tr');
    eRow.innerHTML=`<td>${data.prevElectric}</td>
                    <td><input type="number"></td>
                    <td><input type="number"></td>
                    <td><input type="number"></td>
                    <td><input type="date"></td>`;
    eBody.appendChild(eRow);
  }

  // ================= SAVE OWNER CHANGES =================
  async function saveOwnerChanges(reg){
    const name = document.getElementById('ownerName').value.trim();
    const gender = document.getElementById('ownerGender').value;
    const phone = document.getElementById('ownerPhone').value.trim();
    const email = document.getElementById('ownerEmail').value.trim();
    const address = document.getElementById('ownerAddress').value.trim();
    const roomRent = Number(document.getElementById('ownerRoomRent').value);

    try{
      await set(dbRef(db, `users/${reg}/personalInfo`), {name, gender, phone, email, address, roomRent});
      alert("Changes saved successfully!");
      loadUsers();
    }catch(err){console.error(err); alert("Error saving changes.");}
  }
</script>

<!-- ================= END OF SLOT 4 ================= -->
  <!-- ================= REGISTRATION SUCCESS PAGE ================= -->
<div id="registrationSuccess" class="form-container" style="display:none;">
  <h2>ðŸŽ‰ Congratulations!</h2>
  <p id="successMessage">You will come to JP RESIDENCY! Your registration number is <strong id="regNumDisplay"></strong></p>
  <p>AAYUSHMAN SINGH WELCOMES YOU</p>
  <div class="form-buttons">
    <button onclick="sendToOwner()">Send Details to Owner via WhatsApp</button>
    <button onclick="showPage('homepage')">Go to Homepage</button>
  </div>
</div>

<script type="module">
  // ================= POST REGISTRATION =================
  async function showRegistrationSuccess(regNumber){
    document.getElementById('regNumDisplay').innerText = regNumber;
    showPage('registrationSuccess');
  }

  // ================= SEND DETAILS TO OWNER =================
  window.sendToOwner = function(){
    const regNumber = document.getElementById('regNumDisplay').innerText;
    const phoneOwner = "9942823314";
    const message = encodeURIComponent(`New JP Residency Registration!\nRegistration Number: ${regNumber}\nBy Aayushman Singh`);
    window.open(`https://wa.me/${phoneOwner}?text=${message}`, '_blank');
  }

  // ================= DAILY REMINDER SIMULATION =================
  // For simulation purposes only (real SMS needs backend)
  async function scheduleReminder(user){
    const livingDate = new Date(user.livingDate);
    const today = new Date();
    const diffDays = Math.floor((today - livingDate)/ (1000*60*60*24));
    if(diffDays>=31){
      alert(`Reminder for ${user.fullname}: WE KINDLY INFORM YOU THAT PLEASE COMPLETE THE PAYMENT OF THE RENT ALONG WITH ELECTRIC BILL. YOUR ONE MONTH HAS BEEN COMPLETED.\nBY AAYUSHMAN SINGH`);
    }
  }

  // ================= MODIFY REGISTRATION SUBMIT =================
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    // All registration logic from Slot 2...
    // After saving to Firebase
    showRegistrationSuccess(regNumber);
    // Schedule reminder simulation
    scheduleReminder({fullname, livingDate});
  });
</script>

<!-- ================= END OF SLOT 5 ================= -->
  <style>
/* ================= FINAL POLISH & RESPONSIVE DESIGN ================= */
body{font-family:'Segoe UI',sans-serif;transition:0.5s;}
.form-container{animation:fadeIn 0.7s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
table{border-collapse:collapse;}
table th, table td{padding:8px;}
button{transition:all 0.3s ease;}
button:hover{transform:scale(1.05);opacity:0.9;}
footer{position:fixed;bottom:5px;width:100%;text-align:center;font-size:14px;color:#ffffff88;}

/* Responsive */
@media(max-width:768px){
  .form-container{width:90%;padding:20px;}
  header h1{font-size:36px;}
  table th, table td{padding:5px;font-size:12px;}
  button{padding:8px 12px;font-size:14px;}
}
</style>

<footer>Live as a Family</footer>

<script>
  // ================= SMOOTH PAGE TRANSITIONS =================
  const pages = ['homepage','registration','login','ownerLogin','userDashboard','ownerDashboard','registrationSuccess'];
  pages.forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.style.transition='all 0.5s ease';
    }
  });

  // ================= WATERMARK =================
  // Already added a big translucent 'A' in background in Slot 1
  // Optional: you can animate watermark for gentle fade
  const watermark = document.querySelector('.watermark');
  let opacity = 0.03;
  setInterval(()=>{
    opacity = opacity===0.03?0.05:0.03;
    watermark.style.color=`rgba(255,255,255,${opacity})`;
  },3000);
</script>

<!-- ================= FULL SYSTEM COMPLETE ================= -->
  </body>
</html>
